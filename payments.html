<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran - Apple Sale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #ee4d2d 0%, #ff6533 50%, #ff7337 100%);
        }
        
        .premium-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ee4d2d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.error {
            background-color: #ef4444;
        }
        
        .notification.info {
            background-color: #3b82f6;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .upload-area.dragover {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .payment-status {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .payment-status.pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .payment-status.verified {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .payment-status.rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .partner-logo {
            transition: all 0.3s ease;
            filter: grayscale(100%);
            opacity: 0.7;
        }
        
        .partner-logo:hover {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.05);
        }
        
        .proof-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .countdown-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .security-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #dbeafe;
            color: #1e40af;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="text-center">
            <h3 id="loadingTitle" class="text-xl font-bold text-gray-800 mb-2">Memuat...</h3>
            <p id="loadingMessage" class="text-gray-600">Mohon tunggu sebentar</p>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>
    
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <a href="index.html" class="flex items-center space-x-2 sm:space-x-3">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-mobile-alt text-white text-base sm:text-xl"></i>
                        </div>
                        <span class="text-lg sm:text-2xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">Apple Sale</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-gray-700 hover:text-orange-600 font-medium transition-colors">Beranda</a>
                    <a href="index.html#products" class="text-gray-700 hover:text-orange-600 font-medium transition-colors">Produk</a>
                    <a href="payments.html" class="text-orange-600 font-medium">Pembayaran</a>
                    <a href="riwayat.html" class="text-gray-700 hover:text-orange-600 font-medium transition-colors">Riwayat</a>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <div id="userProfile" class="flex items-center space-x-2 sm:space-x-3">
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <div class="relative">
                                <div id="userStatusIndicator" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white text-xs sm:text-sm"></i>
                                </div>
                            </div>
                            <span id="userName" class="text-gray-700 font-medium text-sm sm:text-base hidden sm:inline"></span>
                        </div>
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="text-gray-500 hover:text-amber-600 transition-colors">
                                <i class="fas fa-chevron-down text-sm"></i>
                            </button>
                            <div id="userMenu" class="hidden absolute right-0 mt-2 w-44 sm:w-48 bg-white rounded-lg shadow-lg py-2">
                                <a href="profil.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-user mr-2"></i>Profil
                                </a>
                                <a href="checkout.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-shopping-cart mr-2"></i>Checkout
                                </a>
                                <a href="payments.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-credit-card mr-2"></i>Pembayaran
                                </a>
                                <a href="riwayat.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-history mr-2"></i>Riwayat Pesanan
                                </a>
                                <hr class="my-2">
                                <button onclick="logout()" class="block w-full text-left px-3 sm:px-4 py-2 text-red-600 hover:bg-red-50 transition-colors text-sm">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="md:hidden text-gray-700" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="py-8 sm:py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Partner Banner -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 mb-8 border border-blue-200">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center space-x-4 mb-4 md:mb-0">
                        <img src="https://cdnpro.eraspace.com/media/wysiwyg/ibox/Logo_IBOX.png" alt="iBox" class="h-12">
                        <div class="h-8 w-px bg-gray-300"></div>
                        <div class="text-center">
                            <p class="text-sm font-medium text-gray-700">Dipersembahkan oleh</p>
                            <p class="text-lg font-bold text-blue-600">iBox & Partner</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="security-badge"><i class="fas fa-shield-alt mr-1"></i>Terpercaya</span>
                        <span class="security-badge"><i class="fas fa-certificate mr-1"></i>OJK Terdaftar</span>
                    </div>
                </div>
            </div>
            
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl sm:text-3xl font-bold">Pembayaran</h1>
                        <a href="checkout.html" class="text-orange-600 hover:text-orange-700 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Checkout
                        </a>
                    </div>
                    
                    <!-- Order Summary -->
                    <div id="orderSummary" class="bg-gray-50 rounded-lg p-6 mb-8">
                        <!-- Order details will be loaded here -->
                    </div>
                    
                    <!-- Payment Timer -->
                    <div id="paymentTimer" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-8">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-clock text-yellow-600 mr-3"></i>
                                <div>
                                    <h3 class="font-bold text-yellow-800">Batas Waktu Pembayaran</h3>
                                    <p class="text-sm text-yellow-700">Selesaikan pembayaran dalam</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div id="countdown" class="text-2xl font-bold text-yellow-800 countdown-timer">24:00:00</div>
                                <p class="text-sm text-yellow-600">Jam:Menit:Detik</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Instructions -->
                    <div class="bg-blue-50 rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold text-blue-800 mb-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            Instruksi Pembayaran
                        </h2>
                        <ol class="text-blue-700 space-y-2">
                            <li class="flex items-start">
                                <span class="font-bold mr-2">1.</span>
                                <span>Transfer down payment sesuai nominal yang tertera ke rekening Bank Jago</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2">2.</span>
                                <span>Screenshot atau foto bukti transfer</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2">3.</span>
                                <span>Upload bukti transfer di bawah ini</span>
                            </li>
                            <li class="flex items-start">
                                <span class="font-bold mr-2">4.</span>
                                <span>Tim kami akan memverifikasi pembayaran dalam 1x24 jam</span>
                            </li>
                        </ol>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="mb-8">
                        <h2 class="text-xl font-bold mb-4">Metode Pembayaran</h2>
                        <div class="space-y-4">
                            <div class="payment-method border-2 border-gray-200 rounded-lg p-4 selected">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-university text-blue-600 text-2xl mr-4"></i>
                                        <div>
                                            <h3 class="font-bold">Transfer Bank Jago</h3>
                                            <p class="text-sm text-gray-600">No. Rek: 104369528550 a.n. Admin Nenda</p>
                                            <p class="text-xs text-green-600 mt-1"><i class="fas fa-shield-alt mr-1"></i>Rekening terverifikasi</p>
                                        </div>
                                    </div>
                                    <span class="payment-status pending">Menunggu Pembayaran</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Proof -->
                    <div class="mb-8">
                        <h2 class="text-xl font-bold mb-4">Upload Bukti Transfer</h2>
                        <div class="upload-area" onclick="document.getElementById('proofUpload').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 mb-2">Klik atau drag & drop untuk upload bukti transfer</p>
                            <p class="text-sm text-gray-500">Format: JPG, PNG (Max 5MB)</p>
                            <input type="file" id="proofUpload" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                        </div>
                        <div id="uploadPreview" class="mt-4 hidden">
                            <!-- Uploaded image preview will be shown here -->
                        </div>
                    </div>
                    
                    <!-- Security Info -->
                    <div class="bg-green-50 rounded-lg p-6 mb-8">
                        <h3 class="font-bold text-green-800 mb-4">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Keamanan Terjamin
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-lock text-green-600 mt-1"></i>
                                <div>
                                    <h4 class="font-medium text-green-800">Enkripsi SSL</h4>
                                    <p class="text-sm text-green-700">Data transaksi diamankan dengan enkripsi tingkat bank</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-user-shield text-green-600 mt-1"></i>
                                <div>
                                    <h4 class="font-medium text-green-800">Privasi Terlindungi</h4>
                                    <p class="text-sm text-green-700">Data pribadi sesuai regulasi perlindungan data</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-certificate text-green-600 mt-1"></i>
                                <div>
                                    <h4 class="font-medium text-green-800">OJK Terdaftar</h4>
                                    <p class="text-sm text-green-700">Diawasi oleh Otoritas Jasa Keuangan</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-handshake text-green-600 mt-1"></i>
                                <div>
                                    <h4 class="font-medium text-green-800">Partner Resmi</h4>
                                    <p class="text-sm text-green-700">Kerjasama dengan iBox terpercaya</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <button onclick="submitPayment()" id="submitBtn" class="w-full bg-gradient-to-r from-amber-400 to-yellow-500 text-black py-3 rounded-lg font-bold hover:shadow-lg transition-all duration-300 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed" disabled>
                        Upload Bukti Pembayaran
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Partner Footer -->
    <div class="bg-gray-100 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-6">
                <h3 class="text-lg font-bold text-gray-700 mb-2">Mitra Pembayaran Terpercaya</h3>
                <p class="text-sm text-gray-600">Bekerjasama dengan institusi keuangan terkemuka</p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 items-center">
                <div class="flex justify-center">
                    <img src="https://cdnpro.eraspace.com/media/wysiwyg/ibox/Logo_IBOX.png" alt="iBox" class="partner-logo h-12 md:h-16 object-contain">
                </div>
                <div class="flex justify-center">
                    <img src="https://east.vc/wp-content/uploads/2025/07/julo-1-1.png" alt="Julo" class="partner-logo h-12 md:h-16 object-contain">
                </div>
                <div class="flex justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/Shopee.svg" alt="Shopee" class="partner-logo h-12 md:h-16 object-contain">
                </div>
                <div class="flex justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/83/OJK_Logo.png" alt="OJK" class="partner-logo h-12 md:h-16 object-contain">
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBRt-74qBrtvop8J7YOWtDOS7gBMp0dsiQ",
            authDomain: "kredit-hp-221a1.firebaseapp.com",
            projectId: "kredit-hp-221a1",
            storageBucket: "kredit-hp-221a1.firebasestorage.app",
            messagingSenderId: "428804203261",
            appId: "1:428804203261:web:51aa0bb8d4a65080a25494",
            measurementId: "G-EJW00GWVS9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        let currentUser = null;
        let currentOrder = null;
        let uploadedFile = null;
        let paymentTimer = null;
        let timeRemaining = 24 * 60 * 60; // 24 hours in seconds
        let userActivityListener = null;
        
        // Get order ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        
        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadOrder();
                await loadUserData();
                setupUserActivityTracking();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // Setup real-time user activity tracking
        function setupUserActivityTracking() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.id);
            
            // Update last activity timestamp
            const updateActivity = () => {
                userRef.update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                }).catch(error => {
                    console.error('Error updating activity:', error);
                });
            };
            
            // Update activity immediately
            updateActivity();
            
            // Update activity every 30 seconds
            const activityInterval = setInterval(updateActivity, 30000);
            
            // Listen for user status changes
            userActivityListener = db.collection('userStatus')
                .doc(currentUser.id)
                .onSnapshot(doc => {
                    const status = doc.data();
                    if (status) {
                        updateUserStatusIndicator(status.status);
                    }
                });
            
            // Update status to online
            db.collection('userStatus').doc(currentUser.id).set({
                userId: currentUser.id,
                status: 'online',
                lastChanged: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Handle page visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    db.collection('userStatus').doc(currentUser.id).update({
                        status: 'away',
                        lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    db.collection('userStatus').doc(currentUser.id).update({
                        status: 'online',
                        lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    updateActivity();
                }
            });
            
            // Handle beforeunload (user closing page)
            window.addEventListener('beforeunload', () => {
                db.collection('userStatus').doc(currentUser.id).update({
                    status: 'offline',
                    lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                });
                clearInterval(activityInterval);
                if (paymentTimer) {
                    clearInterval(paymentTimer);
                }
            });
        }
        
        // Update user status indicator
        function updateUserStatusIndicator(status) {
            const indicator = document.getElementById('userStatusIndicator');
            if (!indicator) return;
            
            switch (status) {
                case 'online':
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                    break;
                case 'away':
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border-2 border-white';
                    break;
                case 'offline':
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                    break;
                default:
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
            }
        }
        
        // Load user data
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};
                
                document.getElementById('userName').textContent = currentUser.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Load order data
        async function loadOrder() {
            if (!orderId) {
                showNotification('Order ID tidak ditemukan', 'error');
                window.location.href = 'checkout.html';
                return;
            }
            
            showLoading('Memuat Data...', 'Mengambil informasi pesanan');
            
            try {
                const orderDoc = await db.collection('orders').doc(orderId).get();
                
                if (!orderDoc.exists) {
                    showNotification('Pesanan tidak ditemukan', 'error');
                    window.location.href = 'checkout.html';
                    return;
                }
                
                currentOrder = { id: orderDoc.id, ...orderDoc.data() };
                
                // Check if order belongs to current user
                if (currentOrder.userId !== currentUser.uid) {
                    showNotification('Anda tidak memiliki akses ke pesanan ini', 'error');
                    window.location.href = 'riwayat.html';
                    return;
                }
                
                // Check if payment is already verified
                if (currentOrder.paymentStatus === 'verified') {
                    showNotification('Pembayaran sudah diverifikasi', 'info');
                    window.location.href = 'riwayat.html';
                    return;
                }
                
                // Display order summary
                displayOrderSummary();
                
                // Start payment timer if order is recent
                if (currentOrder.orderDate) {
                    const orderTime = currentOrder.orderDate.toDate();
                    const now = new Date();
                    const timeDiff = Math.floor((now - orderTime) / 1000); // seconds
                    
                    if (timeDiff < 24 * 60 * 60) { // Less than 24 hours
                        timeRemaining = (24 * 60 * 60) - timeDiff;
                        startPaymentTimer();
                    }
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error loading order:', error);
                showNotification('Gagal memuat data pesanan', 'error');
            }
        }
        
        // Display order summary
        function displayOrderSummary() {
            const orderSummary = document.getElementById('orderSummary');
            
            const orderDate = currentOrder.orderDate ? new Date(currentOrder.orderDate.toDate()).toLocaleDateString('id-ID') : 'N/A';
            
            orderSummary.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-lg">Order #${currentOrder.id}</h3>
                        <p class="text-gray-600">${currentOrder.productName} - ${currentOrder.productVariant}</p>
                        <p class="text-sm text-gray-500">Tanggal: ${orderDate}</p>
                    </div>
                    <span class="payment-status ${currentOrder.paymentStatus || 'pending'}">
                        ${currentOrder.paymentStatus === 'verified' ? 'Terverifikasi' : currentOrder.paymentStatus === 'rejected' ? 'Ditolak' : 'Menunggu Pembayaran'}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Total Harga:</span>
                        <p class="font-medium">Rp ${currentOrder.totalPrice.toLocaleString('id-ID')}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">Down Payment:</span>
                        <p class="font-bold text-amber-600">Rp ${currentOrder.downPayment.toLocaleString('id-ID')}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">Tenor:</span>
                        <p class="font-medium">${currentOrder.tenor} Bulan</p>
                    </div>
                    <div>
                        <span class="text-gray-500">Cicilan/Bulan:</span>
                        <p class="font-medium">Rp ${currentOrder.monthlyPayment.toLocaleString('id-ID')}</p>
                    </div>
                </div>
            `;
        }
        
        // Start payment timer
        function startPaymentTimer() {
            const timerElement = document.getElementById('countdown');
            const timerContainer = document.getElementById('paymentTimer');
            
            timerContainer.classList.remove('hidden');
            
            paymentTimer = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(paymentTimer);
                    timerElement.textContent = 'Waktu Habis';
                    timerElement.classList.add('text-red-600');
                    
                    // Cancel order if time is up
                    cancelOrder();
                    return;
                }
                
                const hours = Math.floor(timeRemaining / 3600);
                const minutes = Math.floor((timeRemaining % 3600) / 60);
                const seconds = timeRemaining % 60;
                
                timerElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Change color when less than 1 hour
                if (timeRemaining < 3600) {
                    timerElement.classList.add('text-red-600');
                }
                
                timeRemaining--;
            }, 1000);
        }
        
        // Cancel order when time is up
        async function cancelOrder() {
            try {
                await db.collection('orders').doc(currentOrder.id).update({
                    status: 'cancelled',
                    cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                    cancellationReason: 'Payment timeout'
                });
                
                showNotification('Waktu pembayaran habis. Pesanan dibatalkan.', 'error');
                
                setTimeout(() => {
                    window.location.href = 'riwayat.html';
                }, 3000);
                
            } catch (error) {
                console.error('Error cancelling order:', error);
            }
        }
        
        // File upload handlers
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                validateAndPreviewFile(file);
            }
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const file = event.dataTransfer.files[0];
            if (file) {
                validateAndPreviewFile(file);
            }
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }
        
        function validateAndPreviewFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Harap upload file gambar (JPG, PNG)', 'error');
                return;
            }
            
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Ukuran file maksimal 5MB', 'error');
                return;
            }
            
            uploadedFile = file;
            
            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadPreview = document.getElementById('uploadPreview');
                uploadPreview.innerHTML = `
                    <div class="relative inline-block">
                        <img src="${e.target.result}" alt="Bukti Transfer" class="proof-preview">
                        <button onclick="removeUpload()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <p class="font-medium">${file.name}</p>
                        <p class="text-xs">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                `;
                uploadPreview.classList.remove('hidden');
                
                // Enable submit button
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.classList.remove('disabled:bg-gray-300', 'disabled:text-gray-500', 'disabled:cursor-not-allowed');
            };
            reader.readAsDataURL(file);
        }
        
        function removeUpload() {
            uploadedFile = null;
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('proofUpload').value = '';
            
            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.classList.add('disabled:bg-gray-300', 'disabled:text-gray-500', 'disabled:cursor-not-allowed');
        }
        
        // Submit payment
        async function submitPayment() {
            if (!uploadedFile) {
                showNotification('Harap upload bukti transfer terlebih dahulu', 'error');
                return;
            }
            
            showLoading('Mengupload...', 'Mengirim bukti pembayaran');
            
            try {
                // Create storage reference
                const storageRef = storage.ref();
                const proofRef = storageRef.child(`payment_proofs/${currentUser.uid}/${currentOrder.id}/${uploadedFile.name}`);
                
                // Upload file
                await proofRef.put(uploadedFile);
                
                // Get download URL
                const downloadURL = await proofRef.getDownloadURL();
                
                // Update order status
                await db.collection('orders').doc(currentOrder.id).update({
                    paymentStatus: 'pending_verification',
                    paymentProofUrl: downloadURL,
                    paymentSubmittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    paymentFileName: uploadedFile.name
                });
                
                // Stop payment timer
                if (paymentTimer) {
                    clearInterval(paymentTimer);
                }
                
                hideLoading();
                showNotification('Bukti pembayaran berhasil diupload! Tim kami akan memverifikasi dalam 1x24 jam.', 'success');
                
                // Redirect to order history after a delay
                setTimeout(() => {
                    window.location.href = 'riwayat.html';
                }, 2000);
                
            } catch (error) {
                hideLoading();
                console.error('Error submitting payment:', error);
                showNotification('Gagal mengupload bukti pembayaran. Silakan coba lagi.', 'error');
            }
        }
        
        // Logout
        async function logout() {
            try {
                // Update user status to offline
                if (currentUser) {
                    await db.collection('userStatus').doc(currentUser.id).update({
                        status: 'offline',
                        lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Stop payment timer
                if (paymentTimer) {
                    clearInterval(paymentTimer);
                }
                
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                showNotification('Gagal keluar', 'error');
            }
        }
        
        // Utility functions
        function showLoading(title = 'Memuat...', message = 'Mohon tunggu sebentar') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('hidden');
        }
        
        function toggleMobileMenu() {
            showNotification('Menu mobile akan segera tersedia!', 'info');
        }
        
        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const userProfile = document.getElementById('userProfile');
            
            if (!userProfile.contains(event.target)) {
                userMenu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>