<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Pesanan - Apple Sale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #ee4d2d 0%, #ff6533 50%, #ff7337 100%);
        }
        
        .premium-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ee4d2d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.error {
            background-color: #ef4444;
        }
        
        .notification.info {
            background-color: #3b82f6;
        }
        
        .order-card {
            transition: all 0.3s ease;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-badge.pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.active {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-badge.completed {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-badge.rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .filter-btn {
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background-color: #f59e0b;
            color: white;
        }
        
        .partner-logo {
            transition: all 0.3s ease;
            filter: grayscale(100%);
            opacity: 0.7;
        }
        
        .partner-logo:hover {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.05);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background-color: #e5e7eb;
        }
        
        .timeline-item.completed::before {
            background-color: #10b981;
        }
        
        .timeline-item.active::before {
            background-color: #f59e0b;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 0.375rem;
            top: 1.25rem;
            width: 1px;
            height: calc(100% + 1rem);
            background-color: #e5e7eb;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="text-center">
            <h3 id="loadingTitle" class="text-xl font-bold text-gray-800 mb-2">Memuat...</h3>
            <p id="loadingMessage" class="text-gray-600">Mohon tunggu sebentar</p>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>
    
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <a href="index.html" class="flex items-center space-x-2 sm:space-x-3">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-mobile-alt text-white text-base sm:text-xl"></i>
                        </div>
                        <span class="text-lg sm:text-2xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">Apple Sale</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-gray-700 hover:text-orange-600 font-medium transition-colors">Beranda</a>
                    <a href="index.html#products" class="text-gray-700 hover:text-orange-600 font-medium transition-colors">Produk</a>
                    <a href="checkout.html" class="text-gray-700 hover:text-orange-600 font-medium transition-colors">Checkout</a>
                    <a href="riwayat.html" class="text-orange-600 font-medium">Riwayat</a>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <div id="userProfile" class="flex items-center space-x-2 sm:space-x-3">
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <div class="relative">
                                <div id="userStatusIndicator" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white text-xs sm:text-sm"></i>
                                </div>
                            </div>
                            <span id="userName" class="text-gray-700 font-medium text-sm sm:text-base hidden sm:inline"></span>
                        </div>
                        <div class="relative">
                            <button onclick="toggleUserMenu()" class="text-gray-500 hover:text-amber-600 transition-colors">
                                <i class="fas fa-chevron-down text-sm"></i>
                            </button>
                            <div id="userMenu" class="hidden absolute right-0 mt-2 w-44 sm:w-48 bg-white rounded-lg shadow-lg py-2">
                                <a href="profil.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-user mr-2"></i>Profil
                                </a>
                                <a href="checkout.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-shopping-cart mr-2"></i>Checkout
                                </a>
                                <a href="payments.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-credit-card mr-2"></i>Pembayaran
                                </a>
                                <a href="riwayat.html" class="block w-full text-left px-3 sm:px-4 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors text-sm">
                                    <i class="fas fa-history mr-2"></i>Riwayat Pesanan
                                </a>
                                <hr class="my-2">
                                <button onclick="logout()" class="block w-full text-left px-3 sm:px-4 py-2 text-red-600 hover:bg-red-50 transition-colors text-sm">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="md:hidden text-gray-700" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="py-8 sm:py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- User Status Banner -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 mb-8 border border-blue-200">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center space-x-4 mb-4 md:mb-0">
                        <div class="relative">
                            <div id="userStatusBanner" class="w-4 h-4 bg-green-500 rounded-full"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">Status Akun</h3>
                            <p id="userStatusText" class="text-sm text-gray-600">Memeriksa status...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>
                            Terverifikasi
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fas fa-shield-alt mr-1"></i>
                            OJK Terdaftar
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold mb-4">Riwayat Pesanan</h1>
                
                <!-- Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <div class="text-2xl font-bold text-orange-600" id="totalOrders">0</div>
                        <div class="text-sm text-gray-600">Total Pesanan</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="activeOrders">0</div>
                        <div class="text-sm text-gray-600">Aktif</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <div class="text-2xl font-bold text-green-600" id="completedOrders">0</div>
                        <div class="text-sm text-gray-600">Selesai</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4 text-center">
                        <div class="text-2xl font-bold text-purple-600" id="totalSpent">Rp 0</div>
                        <div class="text-sm text-gray-600">Total Pengeluaran</div>
                    </div>
                </div>
                
                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button onclick="filterOrders('all')" class="filter-btn active px-4 py-2 rounded-lg border border-gray-300 font-medium">
                        Semua
                    </button>
                    <button onclick="filterOrders('pending')" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 font-medium">
                        Menunggu
                    </button>
                    <button onclick="filterOrders('active')" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 font-medium">
                        Aktif
                    </button>
                    <button onclick="filterOrders('completed')" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 font-medium">
                        Selesai
                    </button>
                    <button onclick="filterOrders('cancelled')" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 font-medium">
                        Dibatalkan
                    </button>
                </div>
            </div>
            
            <!-- Orders List -->
            <div id="ordersList" class="space-y-4">
                <!-- Orders will be loaded here -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <i class="fas fa-shopping-cart text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-bold text-gray-600 mb-2">Belum Ada Pesanan</h3>
                <p class="text-gray-500 mb-6">Anda belum memiliki riwayat pesanan</p>
                <a href="index.html#products" class="inline-block bg-gradient-to-r from-amber-400 to-yellow-500 text-black px-6 py-3 rounded-lg font-bold hover:shadow-lg transition-all duration-300">
                    Belanja Sekarang
                </a>
            </div>
        </div>
    </main>
    
    <!-- Partner Footer -->
    <div class="bg-gray-100 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-6">
                <h3 class="text-lg font-bold text-gray-700 mb-2">Mitra Pembayaran Terpercaya</h3>
                <p class="text-sm text-gray-600">Bekerjasama dengan institusi keuangan terkemuka</p>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 items-center">
                <div class="flex justify-center">
                    <img src="https://cdnpro.eraspace.com/media/wysiwyg/ibox/Logo_IBOX.png" alt="iBox" class="partner-logo h-12 md:h-16 object-contain">
                </div>
                <div class="flex justify-center">
                    <img src="https://east.vc/wp-content/uploads/2025/07/julo-1-1.png" alt="Julo" class="partner-logo h-12 md:h-16 object-contain">
                </div>
                <div class="flex justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/Shopee.svg" alt="Shopee" class="partner-logo h-12 md:h-16 object-contain">
                </div>
                <div class="flex justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/83/OJK_Logo.png" alt="OJK" class="partner-logo h-12 md:h-16 object-contain">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
        <div class="modal-content" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); margin: 5% auto; padding: 0; border-radius: 16px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: modalSlide 0.3s ease-out;">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Detail Pesanan</h2>
                    <button onclick="closeModal('orderDetailModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="orderDetailContent">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBRt-74qBrtvop8J7YOWtDOS7gBMp0dsiQ",
            authDomain: "kredit-hp-221a1.firebaseapp.com",
            projectId: "kredit-hp-221a1",
            storageBucket: "kredit-hp-221a1.firebasestorage.app",
            messagingSenderId: "428804203261",
            appId: "1:428804203261:web:51aa0bb8d4a65080a25494",
            measurementId: "G-EJW00GWVS9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let orders = [];
        let filteredOrders = [];
        let currentFilter = 'all';
        let userActivityListener = null;
        
        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadOrders();
                await loadUserData();
                setupUserActivityTracking();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // Setup real-time user activity tracking
        function setupUserActivityTracking() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.id);
            
            // Update last activity timestamp
            const updateActivity = () => {
                userRef.update({
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                }).catch(error => {
                    console.error('Error updating activity:', error);
                });
            };
            
            // Update activity immediately
            updateActivity();
            
            // Update activity every 30 seconds
            const activityInterval = setInterval(updateActivity, 30000);
            
            // Listen for user status changes
            userActivityListener = db.collection('userStatus')
                .doc(currentUser.id)
                .onSnapshot(doc => {
                    const status = doc.data();
                    if (status) {
                        updateUserStatusIndicator(status.status);
                        updateUserStatusBanner(status.status);
                    }
                });
            
            // Update status to online
            db.collection('userStatus').doc(currentUser.id).set({
                userId: currentUser.id,
                status: 'online',
                lastChanged: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Handle page visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    db.collection('userStatus').doc(currentUser.id).update({
                        status: 'away',
                        lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    db.collection('userStatus').doc(currentUser.id).update({
                        status: 'online',
                        lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    updateActivity();
                }
            });
            
            // Handle beforeunload (user closing page)
            window.addEventListener('beforeunload', () => {
                db.collection('userStatus').doc(currentUser.id).update({
                    status: 'offline',
                    lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                });
                clearInterval(activityInterval);
            });
        }
        
        // Update user status indicator
        function updateUserStatusIndicator(status) {
            const indicator = document.getElementById('userStatusIndicator');
            if (!indicator) return;
            
            switch (status) {
                case 'online':
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white';
                    break;
                case 'away':
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full border-2 border-white';
                    break;
                case 'offline':
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
                    break;
                default:
                    indicator.className = 'absolute -top-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white';
            }
        }
        
        // Update user status banner
        function updateUserStatusBanner(status) {
            const banner = document.getElementById('userStatusBanner');
            const text = document.getElementById('userStatusText');
            
            switch (status) {
                case 'online':
                    banner.className = 'w-4 h-4 bg-green-500 rounded-full';
                    text.textContent = 'Sedang aktif';
                    break;
                case 'away':
                    banner.className = 'w-4 h-4 bg-yellow-500 rounded-full';
                    text.textContent = 'Menjauh dari perangkat';
                    break;
                case 'offline':
                    banner.className = 'w-4 h-4 bg-gray-400 rounded-full';
                    text.textContent = 'Offline';
                    break;
                default:
                    banner.className = 'w-4 h-4 bg-gray-400 rounded-full';
                    text.textContent = 'Status tidak diketahui';
            }
        }
        
        // Load user data
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};
                
                document.getElementById('userName').textContent = currentUser.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`;
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Load orders
        async function loadOrders() {
            showLoading('Memuat Riwayat...', 'Mengambil data pesanan');
            
            try {
                const ordersSnapshot = await db.collection('orders')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('orderDate', 'desc')
                    .get();
                
                orders = [];
                ordersSnapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                filteredOrders = [...orders];
                
                updateStatistics();
                displayOrders();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error loading orders:', error);
                showNotification('Gagal memuat riwayat pesanan', 'error');
            }
        }
        
        // Update statistics
        function updateStatistics() {
            const totalOrders = orders.length;
            const activeOrders = orders.filter(order => order.status === 'active').length;
            const completedOrders = orders.filter(order => order.status === 'completed').length;
            const totalSpent = orders.reduce((sum, order) => {
                return sum + (order.status !== 'cancelled' ? order.totalPrice : 0);
            }, 0);
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('activeOrders').textContent = activeOrders;
            document.getElementById('completedOrders').textContent = completedOrders;
            document.getElementById('totalSpent').textContent = 'Rp ' + totalSpent.toLocaleString('id-ID');
        }
        
        // Display orders
        function displayOrders() {
            const ordersList = document.getElementById('ordersList');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            ordersList.innerHTML = filteredOrders.map(order => {
                const orderDate = order.orderDate ? new Date(order.orderDate.toDate()).toLocaleDateString('id-ID') : 'N/A';
                const statusClass = getStatusClass(order.status);
                const statusText = getStatusText(order.status);
                
                return `
                    <div class="order-card bg-white rounded-lg shadow p-6 cursor-pointer" onclick="showOrderDetail('${order.id}')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold">${order.productName}</h3>
                                <p class="text-sm text-gray-600">Order #${order.id}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-calendar-alt mr-1"></i>${orderDate}
                                </p>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                            <div>
                                <span class="text-gray-500">Total:</span>
                                <p class="font-medium">Rp ${order.totalPrice.toLocaleString('id-ID')}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">DP:</span>
                                <p class="font-medium">Rp ${order.downPayment.toLocaleString('id-ID')}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Tenor:</span>
                                <p class="font-medium">${order.tenor} Bulan</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Cicilan:</span>
                                <p class="font-medium">Rp ${order.monthlyPayment.toLocaleString('id-ID')}/bln</p>
                            </div>
                        </div>
                        
                        <!-- Order Timeline -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-medium text-sm text-gray-700 mb-3">Timeline Pesanan</h4>
                            <div class="space-y-3">
                                <div class="timeline-item completed">
                                    <div class="text-xs text-gray-500">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        Pesanan dibuat
                                    </div>
                                    <div class="text-xs text-gray-600 ml-4">
                                        ${order.orderDate ? new Date(order.orderDate.toDate()).toLocaleString('id-ID') : 'N/A'}
                                    </div>
                                </div>
                                
                                ${order.paymentStatus === 'verified' ? `
                                    <div class="timeline-item completed">
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            Pembayaran diverifikasi
                                        </div>
                                        <div class="text-xs text-gray-600 ml-4">
                                            ${order.paymentVerifiedAt ? new Date(order.paymentVerifiedAt.toDate()).toLocaleString('id-ID') : 'N/A'}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${order.status === 'active' ? `
                                    <div class="timeline-item active">
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-clock text-yellow-500 mr-2"></i>
                                            Sedang aktif
                                        </div>
                                        <div class="text-xs text-gray-600 ml-4">
                                            Cicilan berjalan
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${order.status === 'completed' ? `
                                    <div class="timeline-item completed">
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                            Selesai
                                        </div>
                                        <div class="text-xs text-gray-600 ml-4">
                                            ${order.completedAt ? new Date(order.completedAt.toDate()).toLocaleString('id-ID') : 'N/A'}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${order.status === 'cancelled' ? `
                                    <div class="timeline-item completed">
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-times-circle text-red-500 mr-2"></i>
                                            Dibatalkan
                                        </div>
                                        <div class="text-xs text-gray-600 ml-4">
                                            ${order.cancelledAt ? new Date(order.cancelledAt.toDate()).toLocaleString('id-ID') : 'N/A'}
                                            ${order.cancellationReason ? `(${order.cancellationReason})` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${order.status === 'pending' && order.paymentStatus !== 'verified' ? `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <a href="payments.html?orderId=${order.id}" class="inline-flex items-center text-orange-600 hover:text-orange-700 font-medium">
                                    <i class="fas fa-credit-card mr-2"></i>
                                    Upload Bukti Pembayaran
                                </a>
                            </div>
                        ` : ''}
                        
                        ${order.status === 'active' ? `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button onclick="makePayment('${order.id}')" class="inline-flex items-center text-green-600 hover:text-green-700 font-medium">
                                    <i class="fas fa-money-bill-wave mr-2"></i>
                                    Bayar Cicilan
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Get status class
        function getStatusClass(status) {
            switch (status) {
                case 'pending':
                    return 'pending';
                case 'active':
                    return 'active';
                case 'completed':
                    return 'completed';
                case 'cancelled':
                    return 'cancelled';
                default:
                    return 'pending';
            }
        }
        
        // Get status text
        function getStatusText(status) {
            switch (status) {
                case 'pending':
                    return 'Menunggu';
                case 'active':
                    return 'Aktif';
                case 'completed':
                    return 'Selesai';
                case 'cancelled':
                    return 'Dibatalkan';
                default:
                    return 'Menunggu';
            }
        }
        
        // Filter orders
        function filterOrders(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Filter orders
            if (filter === 'all') {
                filteredOrders = [...orders];
            } else {
                filteredOrders = orders.filter(order => order.status === filter);
            }
            
            displayOrders();
        }
        
        // Show order detail
        function showOrderDetail(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const orderDate = order.orderDate ? new Date(order.orderDate.toDate()).toLocaleDateString('id-ID') : 'N/A';
            const statusClass = getStatusClass(order.status);
            const statusText = getStatusText(order.status);
            
            document.getElementById('orderDetailContent').innerHTML = `
                <div class="space-y-6">
                    <!-- Order Information -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold mb-2">Informasi Pesanan</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Order ID:</span>
                                <p class="font-medium">#${order.id}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Status:</span>
                                <p class="font-medium">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </p>
                            </div>
                            <div>
                                <span class="text-gray-500">Tanggal Pesan:</span>
                                <p class="font-medium">${orderDate}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Metode Pembayaran:</span>
                                <p class="font-medium">${getPaymentMethodText(order.paymentMethod)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Information -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold mb-2">Detail Produk</h3>
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden">
                                <i class="fas fa-mobile-alt text-gray-400 text-2xl w-full h-full flex items-center justify-center"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">${order.productName}</h4>
                                <p class="text-gray-600">${order.productVariant}</p>
                                <p class="text-orange-600 font-bold">Rp ${order.totalPrice.toLocaleString('id-ID')}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Information -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold mb-2">Rincian Pembayaran</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Total Harga:</span>
                                <span class="font-medium">Rp ${order.totalPrice.toLocaleString('id-ID')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Down Payment:</span>
                                <span class="font-medium">Rp ${order.downPayment.toLocaleString('id-ID')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Sisa Pembayaran:</span>
                                <span class="font-medium">Rp ${(order.totalPrice - order.downPayment).toLocaleString('id-ID')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tenor Cicilan:</span>
                                <span class="font-medium">${order.tenor} Bulan</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cicilan per Bulan:</span>
                                <span class="font-bold text-amber-600">Rp ${order.monthlyPayment.toLocaleString('id-ID')}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Personal Information -->
                    ${order.personalInfo ? `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-bold mb-2">Informasi Pribadi</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">NIK:</span>
                                    <p class="font-medium">${order.personalInfo.nik || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-gray-500">Tempat Lahir:</span>
                                    <p class="font-medium">${order.personalInfo.birthPlace || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-gray-500">Tanggal Lahir:</span>
                                    <p class="font-medium">${order.personalInfo.birthDate || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-gray-500">Jenis Kelamin:</span>
                                    <p class="font-medium">${order.personalInfo.gender === 'L' ? 'Laki-laki' : order.personalInfo.gender === 'P' ? 'Perempuan' : '-'}</p>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-gray-500">Alamat:</span>
                                    <p class="font-medium">${order.personalInfo.address || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-gray-500">Pekerjaan:</span>
                                    <p class="font-medium">${order.personalInfo.occupation || '-'}</p>
                                </div>
                                <div>
                                    <span class="text-gray-500">Penghasilan:</span>
                                    <p class="font-medium">${getIncomeText(order.personalInfo.income)}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-4">
                        <button onclick="closeModal('orderDetailModal')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400 transition-colors">
                            Tutup
                        </button>
                        ${order.status === 'pending' && order.paymentStatus !== 'verified' ? `
                            <a href="payments.html?orderId=${order.id}" class="flex-1 bg-gradient-to-r from-amber-400 to-yellow-500 text-black py-3 rounded-lg font-bold hover:shadow-lg transition-all duration-300 text-center">
                                Upload Bukti Pembayaran
                            </a>
                        ` : ''}
                        ${order.status === 'active' ? `
                            <button onclick="makePayment('${order.id}')" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition-colors">
                                Bayar Cicilan
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            showModal('orderDetailModal');
        }
        
        // Get payment method text
        function getPaymentMethodText(method) {
            const methods = {
                'jago': 'Transfer Bank Jago'
            };
            return methods[method] || method;
        }
        
        // Get income text
        function getIncomeText(income) {
            const incomes = {
                '3-5': 'Rp 3-5 Juta',
                '5-10': 'Rp 5-10 Juta',
                '10-20': 'Rp 10-20 Juta',
                '20+': 'Rp 20+ Juta'
            };
            return incomes[income] || income || '-';
        }
        
        // Make payment (for active orders)
        function makePayment(orderId) {
            showNotification('Fitur pembayaran cicilan akan segera tersedia!', 'info');
        }
        
        // Logout
        async function logout() {
            try {
                // Update user status to offline
                if (currentUser) {
                    await db.collection('userStatus').doc(currentUser.id).update({
                        status: 'offline',
                        lastChanged: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                showNotification('Gagal keluar', 'error');
            }
        }
        
        // Utility functions
        function showLoading(title = 'Memuat...', message = 'Mohon tunggu sebentar') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('hidden');
        }
        
        function toggleMobileMenu() {
            showNotification('Menu mobile akan segera tersedia!', 'info');
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('userMenu');
            const userProfile = document.getElementById('userProfile');
            
            if (!userProfile.contains(event.target)) {
                userMenu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>